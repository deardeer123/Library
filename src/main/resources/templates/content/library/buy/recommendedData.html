<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragment/library/library_detail_layout}">

<th:block layout:fragment="content_css">
    <!-- html 파일이 열릴때 같이 실행되는 css -->
    <!-- <link rel="stylesheet" href="/"> -->
</th:block>

<th:block layout:fragment="contentFragment">
    <!-- html 코드 작성 -->
    <div class="row">
        <div class="col">
            <div class="row mt-3 mb-3">
                <div class="col text-center">
                    <p class="fs-3">추천자료 등록 및 취소</p>
                </div>
            </div>
            <form action="/bookAdmin/recommendedData" method="post" id="search-tag">
                <div class="row">
                    <div class="col">
                        <!-- 검색기능 -->

                        <div class="border border-success-subtle rounded-2">
                            <div class="row">
                                <div class="col-1 mt-4 ms-3">카테고리</div>
                                <div class="col-2 mt-1 mb-1">
                                    <select class="form-select" th:onchange="cateChk(this,[[${cateList}]])"
                                        name="bookCateName">
                                        <option value="noCate" checked>대분류</option>
                                        <th:block th:each="e : ${cateList}">
                                            <option th:value="${e.bookCateName}"
                                                th:selected="${e.bookCateName == bookSearchVO.bookCateName}">
                                                [[${e.bookCateName}]]</option>
                                        </th:block>
                                    </select>

                                    <select class="form-select" id="cate-tag" name="bookMidCateName">
                                        <option value="noMidCate">중분류</option>
                                        <th:block
                                            th:if='${bookSearchVO.bookMidCateName != null and bookSearchVO.bookMidCateName != "noMidCate"}'>
                                            <th:block th:each="e:${cateList}">
                                                <th:block th:if="${e.bookCateName == bookSearchVO.bookCateName}"
                                                    th:each="e1:${e.libraryBookMidCategoryVOList}">
                                                    <option
                                                        th:selected="${e1.bookMidCateName == bookSearchVO.bookMidCateName}"
                                                        th:value="${e1.bookMidCateName}">[[${e1.bookMidCateName}]]
                                                    </option>
                                                </th:block>
                                            </th:block>
                                        </th:block>
                                    </select>

                                </div>
                                <div class="col-auto mt-4">대출여부</div>
                                <div class="col-auto">
                                    <select class="form-select mt-3" name="bookBorrowAvailable">
                                        <option value="ALL">전체보기</option>
                                        <option value="Y" th:selected='${bookSearchVO.bookBorrowAvailable=="Y"}'>대출가능
                                        </option>
                                        <option value="N" th:selected='${bookSearchVO.bookBorrowAvailable=="N"}'>대출불가
                                        </option>
                                    </select>
                                </div>

                                <div class="col-2">
                                    <!-- 카테고리 -->
                                    <select class="form-select mt-3" aria-label="Default select example"
                                        name="searchType" id="search-type">
                                        <option value="BOOK_TITLE"
                                            th:selected="${bookSearchVO.searchType == 'BOOK_TITLE' }">책이름
                                        </option>
                                        <option value="BOOK_WRITER"
                                            th:selected="${bookSearchVO.searchType == 'BOOK_WRITER'}">저자
                                        </option>
                                        <option value="BOOK_PUB" th:selected="${bookSearchVO.searchType == 'BOOK_PUB'}">
                                            출판사
                                        </option>
                                    </select>
                                </div>
                                <div class="col-3 mt-3">
                                    <!-- 검색 -->
                                    <input type="text" class="form-control" name="searchValue" id="search-value"
                                        th:value="${bookSearchVO.searchValue}">
                                </div>
                                <div class="col mt-3">
                                    <!-- 검색 버튼 -->
                                    <input type="submit" class="btn btn-primary" value="검색">
                                </div>
                            </div>
                        </div>

                    </div>
                </div>


                <div class="row">
                    <div class="col">

                        <div class="row mt-3">
                            <div class="col-auto">
                                현재 보고 있는 추천 책 목록
                            </div>

                            <div class="col-auto">
                                <select class="form-select" name="userType" onchange="()=>{
                                    let tag = document.querySelector('search-tag')
                                    tag.submit()

                                }">
                                    <option value="not" th:selected="${bookSearchVO.userType == '' or bookSearchVO.userType == null}">설정 안함</option>
                                    <option value="all" th:selected="${bookSearchVO.userType == 'all'}">전체</option>
                                    <option value="adult" th:selected="${bookSearchVO.userType == 'adult'}">성인</option>
                                    <option value="teenager" th:selected="${bookSearchVO.userType == 'teenager'}">청소년</option>
                                    <option value="children" th:selected="${bookSearchVO.userType == 'children'}">어린이</option>
                                    <option value="baby" th:selected="${bookSearchVO.userType == 'baby'}">유아</option>
                                </select>
                            </div>

                            <div class="col-auto">
                                <button class="btn btn-primary" onclick="()=>{
                                    let recommendedType = document.querySelector('#recommendedType')
                                    
                                }">추천 연령대 책 보기</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div class="row mt-2">
                <div class="col">
                    <table class="table table-striped">
                        <colgroup>
                            <col width="13%">
                            <col width="*%">
                            <col width="25%">
                            <col width="15%">
                            <col width="10%">
                            <col width="10%">
                        </colgroup>
                        <thead>
                            <tr>
                                <td>책 코드</td>
                                <td>책 제목</td>
                                <td>책 저자</td>
                                <td>책 출판사</td>
                                <td>출판년도</td>
                                <td>추천연령</td>
                            </tr>
                        </thead>

                        <tbody id="book-list">
                            <th:block th:each="e:${bookList}">
                                <tr th:onclick="goModal([[${e.bookCode}]])">
                                    <td>[[${e.bookCode}]]</td>
                                    <td>[[${e.bookTitle}]]</td>
                                    <td>[[${e.bookWriter}]]</td>
                                    <td>[[${e.bookPub}]]</td>
                                    <td>[[${e.bookYear}]]</td>
                                    <td>
                                        <th:block th:if="${e.userType == 'adult'}">
                                            성인
                                        </th:block>
                                        <th:block th:if="${e.userType == 'teenager'}">
                                            청소년
                                        </th:block>
                                        <th:block th:if="${e.userType == 'children'}">
                                            어린이
                                        </th:block>
                                        <th:block th:if="${e.userType == 'baby'}">
                                            유아
                                        </th:block>
                                        <th:block th:if="${e.userType == '' or e.userType == null}">
                                            없음
                                        </th:block>
                                    </td>
                                </tr>
                            </th:block>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 페이징 처리 -->


            <!--  모달-->
            <!-- Modal -->
            <div class="modal fade" id="book-modal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-body" id="book-detail-modal">
                            <!-- 북 상세보기 모달 -->
                            <div class="row">
                                <div class="col">
                                    <!-- 책 상세 정보들 넣어주기 -->

                                    <div class="row">
                                        <div class="col-6">
                                            <!-- 책 사진 들어가는곳  -->
                                            <img src="/upload/book_character_smile.png" width="261px" height="383px"
                                                alt="">
                                        </div>

                                        <div class="col-6">
                                            <div class="row mt-5">
                                                <!-- 북 코드 -->
                                                <div class="col-2">코드 :</div>
                                                <div class="col">GR0000012345</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 제목 -->
                                                <div class="col-2">제목 :</div>
                                                <div class="col">책 제목
                                                </div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 저자 -->
                                                <div class="col-2">저자 :</div>
                                                <div class="col">저자</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 출판사 -->
                                                <div class="col-3">출판사 :</div>
                                                <div class="col">출판사123</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 현재 이 책을 빌릴 수 있는지 확인 -->
                                                <div class="col-4">대출 여부 :</div>
                                                <div class="col">Y</div>
                                            </div>

                                            <div class="row mt-2">
                                                <div class="col-4">빌린 횟수 :</div>
                                                <div class="col">0</div>
                                            </div>

                                            <!-- 만약 빌린 사람이 있는 경우는 아래의 정보 출력해야함  -->
                                            <div class="row mt-2">
                                                <div class="col-4">회원 코드 :</div>
                                                <div class="col">12345</div>
                                            </div>

                                            <div class="row mt-2">
                                                <div class="col-4">대출 일자 :</div>
                                                <div class="col">2024-03-08</div>
                                            </div>

                                            <div class="row mt-2">
                                                <div class="col-4">대츨 코드 :</div>
                                                <div class="col">12345</div>
                                            </div>

                                            <div class="row mt-2">
                                                <div class="col-4">반납 일자:</div>
                                                <div class="col">2024-03-22</div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="row text-center mt-2">
                                        <!-- 카테고리 -->
                                        <div class="col-2">카테고리 :</div>
                                        <div class="col-5">대분류 ></div>
                                        <div class="col-5">중분류</div>
                                    </div>

                                    <div class="row mt-2">
                                        <!-- 책 소개 -->
                                        <div class="col">
                                            <div class="row  text-center">
                                                <div class="col" style="border-bottom: solid 1px black;">
                                                    책소개
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col">
                                                    책소개 123123

                                                    
                                                </div>
                                            </div>
                                        </div>
                                    </div>



                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                         
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <input type="hidden" id="recommended-type-value-tag" value="audlt">
    </div>
    <script>
        function goModal(bookCode) {

            let book_modal = new bootstrap.Modal('#book-modal');


            //------------------- 첫번째 방식 ---------------//
            fetch('/bookAdmin/bookDetailInfoFetch', { //요청경로
                method: 'POST',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                //컨트롤러로 전달할 데이터
                body: new URLSearchParams({
                    // 데이터명 : 데이터값
                    bookCode: bookCode
                })
            })
                .then((response) => {
                    if (!response.ok) {
                        alert('fetch error!\n컨트롤러로 통신중에 오류가 발생했습니다.');
                        return;
                    }

                    //return response.text(); //컨트롤러에서 return하는 데이터가 없거나 int, String 일 때 사용
                    return response.json(); //나머지 경우에 사용
                })
                //fetch 통신 후 실행 영역
                .then((data) => {//data -> controller에서 리턴되는 데이터!
                    console.log(data);
                    const bookBorrowList = data.memberVO.bookBorrowList[0]
                    console.log("bookBorrowList")
                    console.log(bookBorrowList);
                    const libraryVO = bookBorrowList.libraryBookVO;
                    console.log("libraryVO")
                    console.log(libraryVO);
                    const libraryBookInfoVO = libraryVO.libraryBookInfoVO;
                    console.log("libraryBookInfoVO")
                    console.log(libraryBookInfoVO);

                    console.log(data.libraryBookCategoryVO.bookCateName);
                    console.log(data.libraryBookCategoryVO.libraryBookMidCategoryVOList[0].bookMidCateName);

                    let book_modal_body = document.querySelector("#book-detail-modal")
                    book_modal_body.innerHTML = '';
                    let str = `
        <div class="row">
                    <div class="col">
                        <!-- 책 상세 정보들 넣어주기 -->

                        <div class="row">
                            <div class="col-6">
                                <!-- 책 사진 들어가는곳  -->
                                <img src="/upload/${libraryBookInfoVO.bookInfoAttachedFileName}" height="383px"
                                    alt="">
                            </div>

                            <div class="col-6">
                                <div class="row mt-3">
                                    <!-- 북 코드 -->
                                    <div class="col-2">코드 :</div>
                                    <div class="col">${libraryVO.bookCode}</div>
                                </div>

                                <div class="row mt-1">
                                    <!-- 제목 -->
                                    <div class="col-2">제목 :</div>
                                    <div class="col">${libraryVO.bookTitle}
                                    </div>
                                </div>

                                <div class="row mt-1">
                                    <!-- 저자 -->
                                    <div class="col-2">저자 :</div>
                                    <div class="col">${libraryVO.bookWriter}</div>
                                </div>

                                <div class="row mt-1">
                                    <!-- 출판사 -->
                                    <div class="col-3">출판사 :</div>
                                    <div class="col">${libraryVO.bookPub}</div>
                                </div>

                                <div class="row mt-1">
                                    <!-- 현재 이 책을 빌릴 수 있는지 확인 -->
                                    <div class="col-4">대출 여부 :</div>
                                    <div class="col">${libraryBookInfoVO.bookBorrowAvailable}</div>
                                </div>

                                <div class="row mt-1">
                                    <div class="col-4">빌린 횟수 :</div>
                                    <div class="col">${libraryBookInfoVO.bookBorrowCnt}</div>
                                </div>

                                <!-- 만약 빌린 사람이 있는 경우는 아래의 정보 출력해야함  -->
                                <div class="row mt-1">
                                    <div class="col-4">회원 코드 :</div>
                                    <div class="col">${data.memberVO.userCode}</div>
                                </div>

                                <div class="row mt-1">
                                    <div class="col-4">회원 아이디 :</div>
                                    <div class="col">${data.memberVO.userId}</div>
                                </div>

                                <div class="row mt-1">
                                    <div class="col-4">회원 이름 :</div>
                                    <div class="col">${data.memberVO.userName}</div>
                                </div>

                                <div class="row mt-1">
                                    <div class="col-4">대출 일자 :</div>
                                    <div class="col">${bookBorrowList.borrowDate}</div>
                                </div>

                                <div class="row mt-1">
                                    <div class="col-4">반납 예정일 :</div>
                                    <div class="col">${bookBorrowList.exReturnDate}</div>
                                </div>
                                

                                <div class="row mt-2">
                                    <div class="col-4">대출 코드 :</div>
                                    <div class="col">${bookBorrowList.borrowCode}</div>
                                </div>

                                <div class="row mt-2">
                                    <div class="col-4">반납 일자:</div>
                                    <div class="col">${bookBorrowList.returnDate}</div>
                                </div>

                            </div>
                        </div>

                        <div class="row text-center mt-2">
                            <!-- 카테고리 -->
                            <div class="col-2">카테고리 :</div>
                            <div class="col-5">${data.libraryBookCategoryVO.bookCateName}</div>
                            <div class="col-5">${data.libraryBookCategoryVO.libraryBookMidCategoryVOList[0].bookMidCateName}</div>
                        </div>

                        <div class="row mt-2 text-center">
                            <div class="col">
                                현재 추천 되어 있는 연령대 : `
                                if(data.userType != null && data.userType != ""){
                                    switch(data.userType){
                                        case 'adult':
                                            str += `성인`
                                            break;
                                        case 'teenager':
                                            str += '청소년'
                                            break;
                                        case 'children':
                                            str += '어린이'
                                            break;
                                        default :
                                            str += '유아'
                                    }
                                }else{
                                    str += `없음`
                                }
                                str += `
                            </div>
                        </div>

                        <div class="row mt-2">
                            <!-- 추천책 -->
                            <div class="col-6">
                                <select class="form-select" id="recommended-type" onchange="typeChange(this)">
                                    <option value="adult"`
                                    if(data.userType == 'adult'){str+= ` selected`}
                                    str += ` >성인</option>
                                    <option value="teenager"`
                                    if(data.userType == 'teenager'){str+= ` selected`}
                                    str += ` >청소년</option>
                                    <option value="children"`
                                    if(data.userType == 'children'){str+= ` selected`}
                                    str += ` >어린이</option>
                                    <option value="baby"`
                                    if(data.userType == 'baby'){str+= ` selected`}
                                    str += ` >유아</option>
                                    <option value="">추천 취소</option>
                                </select>
                            </div>
                            <div class="col-6 d-grid">
                                <button class="btn btn-primary" onclick="recommendedBook('${libraryVO.bookCode}')">책 추천하기/ 변경 하기 </button>
                            </div>   
                        </div>
                    </div>
                </div>
        `
                    book_modal_body.insertAdjacentHTML('beforeend', str)
                    book_modal.show();

                })
                //fetch 통신 실패 시 실행 영역
                .catch(err => {
                    alert('fetch error!\nthen 구문에서 오류가 발생했습니다.\n콘솔창을 확인하세요!');
                    console.log(err);
                });
        }
        function typeChange(tag){
           
            let recommended_type_value_tag = document.querySelector('#recommended-type-value-tag')
            recommended_type_value_tag.value = tag.value
            // alert(recommended_type_value_tag.value)ㄴ
        }

        function recommendedBook(bookCode){
            let recommended_type_value_tag = document.querySelector('#recommended-type-value-tag')
            const userType = recommended_type_value_tag.value;

            location.href=`/bookAdmin/addRecommendedBook?bookCode=${bookCode}&userType=${userType}`
        }
    </script>

</th:block>

<th:block layout:fragment="content_js">
    <!-- html 파일이 열릴때 같이 실행되는 js -->
    <!-- <script src="/"></script> -->
</th:block>

</html>