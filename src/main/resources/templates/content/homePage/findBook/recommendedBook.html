<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragment/homePage/homePage_detail_layout}">

<th:block layout:fragment="content_css">
    <!-- html 파일이 열릴때 같이 실행되는 css -->
    <!-- <link rel="stylesheet" href="/"> -->
</th:block>

<th:block layout:fragment="contentFragment">
    <!-- html 코드 작성 -->
    <div class="row">
        <div class="col">

            <div class="text-center fs-1">추천 연령</div>

            <div class="row row-cols-5 mt-3 mb-3">
                <div class="col d-grid">
                    <input type="button" class="btn btn-primary" value="전체" onclick="changeRecommended('all')">
                </div>
                <div class="col d-grid">
                    <input type="button" class="btn btn-primary" value="성인" onclick="changeRecommended('adult')">
                </div>
                <div class="col d-grid">
                    <input type="button" class="btn btn-primary" value="청소년" onclick="changeRecommended('teenager')">
                </div>
                <div class="col d-grid">
                    <input type="button" class="btn btn-primary" value="어린이" onclick="changeRecommended('children')">
                </div>
                <div class="col d-grid">
                    <input type="button" class="btn btn-primary" value="유아" onclick="changeRecommended('baby')">
                </div>
            </div>

            <div class="row g-2">
                <!-- <div class="col-6">
                    <div class="p-4 border border-success-subtle border-3">
                        <div class="row align-items-center">
                            <div class="col">
                           
                                <img src="/upload/순돌아도망쳐.jpg" width="90%" style="height: 25vh;">
                            </div>

                            <div class="col">

                                <div style="font-weight: bold; font-size: large;">순돌아도망쳐</div>
                                <div><span style="color: blueviolet;">지은이 :</span> 김자환</div>
                                <div><span style="color: blueviolet;">출판사 :</span> 삼성당</div>
                                <div><span style="color: blueviolet;">카테고리 :</span> 국내도서 > 동화책</div>
                                <div><span style="color: blueviolet;">책 정보 :</span> 도지야 도망쳐!!!!!!!</div>
                            </div>
                        </div>
                    </div>
                </div> -->

                <th:block th:each="e:${bookList}">
                    <div class="col-6" th:onclick="bookDetail([[${e.bookCode}]])">
                        <div class="p-4 border border-success-subtle border-3">
                            <div class="row align-items-center">
                                <div class="col-6">
                                    <!--  그림 부분 -->
                                    <img th:src="@{/upload/} + ${e.bookInfoAttachedFileName}" width="90%"
                                        style="height: 25vh;">
                                </div>

                                <div class="col-6">
                                    <!-- 책 정보 -->
                                    <div
                                        style="font-weight: bold;
                                 font-size: large; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 95%;">
                                        [[${e.bookTitle}]]
                                    </div>
                                    <div
                                        class="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 95%;">
                                        <span style="color: blueviolet;">지은이 :</span> <span>[[${e.bookWriter}]]</span>
                                    </div>
                                    <div
                                        class="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 95%;">
                                        <span style="color: blueviolet;">출판사 :</span><span>[[${e.bookPub}]]</span>
                                    </div>
                                    <div
                                        clASS="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 95%;">
                                        <span style="color: blueviolet;">카테고리 :</span> <span>[[${e.bookCateName}]] >
                                            [[${e.bookMidCateName}]]</span>
                                    </div>
                                    <div
                                        style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 95%;">
                                        <span style="color: blueviolet;">책 정보 :</span> <span>[[${e.bookIntro}]]</span>
                                    </div>
                                    <div>
                                        <span style="color: blueviolet;">추천연령 :</span>
                                        <span>
                                            <th:block th:if="${e.userType == 'adult'}">
                                                성인
                                            </th:block>
                                            <th:block th:if="${e.userType == 'children'}">
                                                어린이
                                            </th:block>
                                            <th:block th:if="${e.userType == 'teenager'}">
                                                청소년
                                            </th:block>
                                            <th:block th:if="${e.userType == 'baby'}">
                                                유아
                                            </th:block>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </th:block>
            </div>
            <!-- Modal -->
            <div class="modal fade" id="book-modal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">

                        <div class="modal-body">
                            <div class="row">
                                <div class="col">
                                    <!-- 책 상세 정보들 넣어주기 -->

                                    <div class="row">
                                        <div class="col-6">
                                            <!-- 책 사진 들어가는곳  -->
                                            <img src="/upload/book_character_smile.png" width="261px" height="383px"
                                                alt="">
                                        </div>

                                        <div class="col-6">
                                            <div class="row mt-5">
                                                <!-- 북 코드 -->
                                                <div class="col-2">코드 :</div>
                                                <div class="col">GR0000012345</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 제목 -->
                                                <div class="col-2">제목 :</div>
                                                <div class="col">책 제목
                                                </div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 저자 -->
                                                <div class="col-2">저자 :</div>
                                                <div class="col">저자</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 출판사 -->
                                                <div class="col-3">출판사 :</div>
                                                <div class="col">출판사123</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 현재 이 책을 빌릴 수 있는지 확인 -->
                                                <div class="col-4">대출 여부 :</div>
                                                <div class="col">Y</div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="row text-center mt-2">
                                        <!-- 카테고리 -->
                                        <div class="col-2">카테고리 :</div>
                                        <div class="col-5">대분류 ></div>
                                        <div class="col-5">중분류</div>
                                    </div>

                                    <div class="row mt-2">
                                        <!-- 책 소개 -->
                                        <div class="col">
                                            <div class="row  text-center">
                                                <div class="col" style="border-bottom: solid 1px black;">
                                                    책소개
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col">
                                                    책소개 123123
                                                </div>
                                            </div>
                                        </div>
                                    </div>



                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                            <!-- 예약하기 버튼 -->
                            <button type="button" onclick="insertR()" class="btn btn-primary">예약하기 </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 지금 로그인을 했는지 안했는지 확인 여부 -->
    <input type="hidden" id="memberId" th:value="${#authentication.name}">
    <script>
        function bookDetail(bookCode) {
            // 책 하나 찾기
            console.log(bookCode)
            //모달 태그 찾기
            let book_modal = new bootstrap.Modal('#book-modal');

            // ------------------- 첫번째 방식 ---------------//
            fetch('/findBookDetailFetch', { //요청경로
                method: 'POST',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                //컨트롤러로 전달할 데이터
                body: new URLSearchParams({
                    // 데이터명 : 데이터값
                    bookCode: bookCode
                })
            })
                .then((response) => {
                    if (!response.ok) {
                        alert('fetch error!\n컨트롤러로 통신중에 오류가 발생했습니다.');
                        return;
                    }

                    //return response.text(); //컨트롤러에서 return하는 데이터가 없거나 int, String 일 때 사용
                    return response.json(); //나머지 경우에 사용
                })
                //fetch 통신 후 실행 영역
                .then((data) => {//data -> controller에서 리턴되는 데이터!
                    console.log(data)
                    let modal_body_Tag = document.querySelector(".modal-body");

                    //안에내용 갈아엎기
                    modal_body_Tag.innerHTML = ''

                    let str = `
                             <div class="row">
                                <div class="col">
                                    <!-- 책 상세 정보들 넣어주기 -->
                                    <div class="row">
                                        <div class="col-6 text-center">
                                            <!-- 책 사진 들어가는곳  -->
                                            <img src="/upload/${data.bookInfoAttachedFileName}" width="261px" height="383px" alt="">
                                        </div>

                                        <div class="col-6 mt-5">
                                            <div class="row mt-5">
                                                <!-- 북 코드 -->
                                                <div class="col-2">코드 :</div>
                                                <div class="col" id="book-code">${data.bookCode}</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 제목 -->
                                                <div class="col-2">제목 :</div>
                                                <div class="col">${data.bookTitle}
                                                </div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 저자 -->
                                                <div class="col-2">저자 :</div>
                                                <div class="col">${data.bookWriter}</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 출판사 -->
                                                <div class="col-3">출판사 :</div>
                                                <div class="col">${data.bookPub}</div>
                                            </div>



                                            <div class="row mt-2">
                                                <!-- 현재 이 책을 빌릴 수 있는지 확인 -->
                                                <div class="col-4">대출 여부 :</div>
                                                <div class="col">${data.bookBorrowAvailable}</div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="row text-center mt-2">
                                        <!-- 카테고리 -->
                                        <div class="col-2">카테고리 </div>
                                        <div class="col-5">대분류 : ${data.bookCateName}</div>
                                        <div class="col-5">중분류 : ${data.bookMidCateName}</div>
                                    </div>

                                    <div class="row mt-2">
                                        <!-- 책 소개 -->
                                        <div class="col">
                                            <div class="row  text-center">
                                                <div class="col" style="border-bottom: solid 1px black;">
                                                    책소개
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col">
                                                    ${data.bookIntro}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                    `

                    modal_body_Tag.insertAdjacentHTML("afterbegin", str)
                    book_modal.show();


                })
                //fetch 통신 실패 시 실행 영역
                .catch(err => {
                    alert('fetch error!\nthen 구문에서 오류가 발생했습니다.\n콘솔창을 확인하세요!');
                    console.log(err);
                });
        }
        const insertR = () => {
            const bookCode = document.querySelector('#book-code').innerHTML;
            let memberId = document.querySelector("#memberId").value;
            if(memberId == 'anonymousUser'){
                alert("로그인 한 다음 이용해주세요.")
                location.href='/login'
            }

           

            fetch('/bookReservationFetch', { //요청경로
                method: 'POST',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                //컨트롤러로 전달할 데이터
                body: new URLSearchParams({
                // 데이터명 : 데이터값
                    bookCode : bookCode

                })
            })
            .then((response) => {
                if(!response.ok){
                    alert('fetch error!\n컨트롤러로 통신중에 오류가 발생했습니다.');
                    return ;
                }

                return response.text(); //컨트롤러에서 return하는 데이터가 없거나 int, String 일 때 사용
                //return response.json(); //나머지 경우에 사용
            })
            //fetch 통신 후 실행 영역
            .then((data) => {//data -> controller에서 리턴되는 데이터!

                // console.log(`${session.userCode}`);

                if(data === 'get'){
                    const result = confirm('예약 되었습니다.\n 예약 내역으로 가시겠습니까?');
                    if(result){
                        window.location.href = `/myBookingList`;
                    }
                }else if(data === 'next'){
                    const result = confirm('예약 되었습니다.\n 예약 내역으로 가시겠습니까?');
                    if(result){
                        window.location.href = `/myBookingList`;
                    }
                }else if(data === 'fail'){
                    const result = confirm('이미 예약 하셨습니다.\n 예약 내역으로 가시겠습니까?');
                    if(result){
                        window.location.href = `/myBookingList`;
                    }
                }
                // 시큐리티로 로그인 페이지 날리기
            })
            //fetch 통신 실패 시 실행 영역
            .catch(err=>{
                alert('fetch error!\nthen 구문에서 오류가 발생했습니다.\n콘솔창을 확인하세요!');
                console.log(err);
            });
        }


        function changeRecommended(userType) {
            location.href = `/recommendedBook?userType=${userType}`
        }
    </script>
</th:block>

<th:block layout:fragment="content_js">
    <!-- html 파일이 열릴때 같이 실행되는 js -->
    <!-- <script src="/"></script> -->
</th:block>

</html>