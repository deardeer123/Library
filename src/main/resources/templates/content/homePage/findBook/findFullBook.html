<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragment/homePage/homePage_detail_layout}">

<th:block layout:fragment="content_css">
    <!-- html 파일이 열릴때 같이 실행되는 css -->
    <!-- <link rel="stylesheet" href="/"> -->

</th:block>

<th:block layout:fragment="contentFragment">
    <style>

    </style>

    <!-- html 코드 작성 -->
    <div class="row">
        <div class="col">

            <!-- Modal -->
            <div class="modal fade" id="book-modal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">

                        <div class="modal-body">
                            <div class="row">
                                <div class="col">
                                    <!-- 책 상세 정보들 넣어주기 -->

                                    <div class="row">
                                        <div class="col-6">
                                            <!-- 책 사진 들어가는곳  -->
                                            <img src="/upload/book_character_smile.png" width="80%" height="383px"
                                                alt="">
                                        </div>

                                        <div class="col-6">
                                            <div class="row mt-5">
                                                <!-- 북 코드 -->
                                                <div class="col-2">코드 :</div>
                                                <div class="col">GR0000012345</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 제목 -->
                                                <div class="col-2">제목 :</div>
                                                <div class="col">책 제목
                                                </div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 저자 -->
                                                <div class="col-2">저자 :</div>
                                                <div class="col">저자</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 출판사 -->
                                                <div class="col-3">출판사 :</div>
                                                <div class="col">출판사123</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 현재 이 책을 빌릴 수 있는지 확인 -->
                                                <div class="col-4">대출 여부 :</div>
                                                <div class="col">Y</div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="row text-center mt-2">
                                        <!-- 카테고리 -->
                                        <div class="col-2">카테고리 :</div>
                                        <div class="col-5">대분류 ></div>
                                        <div class="col-5">중분류</div>
                                    </div>

                                    <div class="row mt-2">
                                        <!-- 책 소개 -->
                                        <div class="col">
                                            <div class="row  text-center">
                                                <div class="col" style="border-bottom: solid 1px black;">
                                                    책소개
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col">
                                                    책소개 123123
                                                </div>
                                            </div>
                                        </div>
                                    </div>



                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                            <!-- 예약하기 버튼 -->
                            <button type="button" class="btn btn-primary" >예약하기 </button>
                        </div>
                    </div>
                </div>
            </div>


            <div class="row mt-2 mb-2">
                <div class="col">
                    <!-- 안내문 -->
                    <div class="border border-success mb-2 rounded-4">
                        <div class="row">
                            <div class="col-2">
                                <img src="/upload/book_character_smile.png" width="100%">
                            </div>
                            <div class="col-10">
                                <p>대출예약신청 로그인 한 다음 자료를 검색한 후 대출 중인 자료(자료상태:대출중)에 한하여 예약이 가능합니다.</p>
                                <p>예약된 도서는 문자 수신후 다음날까지 도서관에서 찾아가시기 바랍니다.</p>
                                <p>(기간내 대출하지 않으면 자동 예약취소됨)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <!-- 검색기능 -->
                    <form action="/findFullBook" method="post">
                        <div class="border border-success-subtle rounded-2">
                            <div class="row">
                                <div class="col-1 mt-4 ms-3">카테고리</div>
                                <div class="col-2 mt-1 mb-1">
                                    <select class="form-select" th:onchange="cateChk(this,[[${cateList}]])"
                                        name="bookCateName">
                                        <option value="noCate" checked>대분류</option>
                                        <th:block th:each="e : ${cateList}">
                                            <option th:value="${e.bookCateName}"
                                                th:selected="${e.bookCateName == bookSearchVO.bookCateName}">
                                                [[${e.bookCateName}]]</option>
                                        </th:block>
                                    </select>

                                    <select class="form-select" id="cate-tag" name="bookMidCateName">
                                        <option value="noMidCate">중분류</option>
                                        <th:block
                                            th:if='${bookSearchVO.bookMidCateName != null and bookSearchVO.bookMidCateName != "noMidCate"}'>
                                            <th:block th:each="e:${cateList}">
                                                <th:block th:if="${e.bookCateName == bookSearchVO.bookCateName}"
                                                    th:each="e1:${e.libraryBookMidCategoryVOList}">
                                                    <option
                                                        th:selected="${e1.bookMidCateName == bookSearchVO.bookMidCateName}"
                                                        th:value="${e1.bookMidCateName}">[[${e1.bookMidCateName}]]
                                                    </option>
                                                </th:block>
                                            </th:block>
                                        </th:block>
                                    </select>

                                </div>
                                <div class="col-auto mt-4">대출여부</div>
                                <div class="col-auto">
                                    <select class="form-select mt-3" name="bookBorrowAvailable">
                                        <option value="ALL">전체보기</option>
                                        <option value="Y" th:selected='${bookSearchVO.bookBorrowAvailable=="Y"}'>대출가능
                                        </option>
                                        <option value="N" th:selected='${bookSearchVO.bookBorrowAvailable=="N"}'>대출불가
                                        </option>
                                    </select>
                                </div>





                                <div class="col-2">
                                    <!-- 카테고리 -->
                                    <select class="form-select mt-3" aria-label="Default select example"
                                        name="searchType" id="search-type">
                                        <option value="BOOK_TITLE"
                                            th:selected="${bookSearchVO.searchType == 'BOOK_TITLE' }">책이름
                                        </option>
                                        <option value="BOOK_WRITER"
                                            th:selected="${bookSearchVO.searchType == 'BOOK_WRITER'}">저자
                                        </option>
                                        <option value="BOOK_PUB" th:selected="${bookSearchVO.searchType == 'BOOK_PUB'}">
                                            출판사
                                        </option>
                                    </select>
                                </div>
                                <div class="col-3 mt-3">
                                    <!-- 검색 -->
                                    <input type="text" class="form-control" name="searchValue" id="search-value"
                                        th:value="${bookSearchVO.searchValue}">
                                </div>
                                <div class="col mt-3">
                                    <!-- 검색 버튼 -->
                                    <input type="submit" class="btn btn-primary" value="검색">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col">
                    <!-- 책들 들어가는곳!!1 -->
                    <div class="row g-2">
                        <th:block th:each="e:${bookList}">
                            <!-- 호버기능 어려워서 그냥 자바스크립트로 구현함 아 클래스로 bookInfo준거 계속 내려와서 그냥 col에 높이 고정시킴-->
                            <div class="col-3 bookdiv" onmouseover="bookinfo1(this)" onmouseout="bookinfo2(this)"
                                style="height: 383px;">

                                <div class="text-center">
                                    <img th:src="@{/upload/} + ${e.bookInfoAttachedFileName}" class="rounded" alt="..."
                                        width="95%" style="height: 40vh;">
                                </div>
                                <!-- 배경색 투명하게 하고 글자색은 하얀색 그리고 일단 none 처리 -->
                                <div class="bookInfo"
                                    style="background-color: rgba(0, 0, 0, 0.8); color: white; position: relative; top: -150px; display: none;">
                                    <!-- 아래 스타일준건 옆으로 튀어나면 ... 이런식으로 나오게 하는 코드 -->
                                    <p class="h6"
                                        style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 200px;">
                                        [[${e.bookTitle}]]</p>
                                    <p class="h6"
                                        style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 200px;">
                                        [[${e.bookWriter}]]</p>
                                    <p class="h6"
                                        style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 200px;">
                                        [[${e.bookPub}]]</p>
                                    <p class="h6"
                                        style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 200px;">
                                        [[${e.bookYear}]]</p>
                                    <div class="row text-center">
                                        <div class="col d-grid">
                                            <input type="button" class="btn btn-primary" value="상세보기"
                                                th:onclick="bookDetail([[${e.bookCode}]])">
                                        </div>
                                    </div>

                                </div>




                                <!-- 책 정보는 일단 안보이게 해놓고 이미지에 마우스 올리면 보이게 -->
                                <!-- display: none; -->


                            </div>
                        </th:block>

                    </div>
                </div>
            </div>

            <!-- 페이징 -->
            <div class="row mt-3">
                <div class="col">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination justify-content-center" id="paging-tag">
                            <th:block>
                                <li class="page-item disabled">
                                    <a class="page-link">Previous</a>
                                    <!-- classappend 추가해야함 -->
                                </li>
                            </th:block>

                            <th:block th:each="e: ${#numbers.sequence(bookSearchVO.beginPage,bookSearchVO.endPage)}">
                                <li class="page-item"><a class="page-link"
                                        th:href="@{/findFullBook(nowPage=${e},searchType=${bookSearchVO.searchType},searchValue=${bookSearchVO.searchValue})}">[[${e}]]</a>
                                </li>
                            </th:block>

                            <th:block>
                                <li class="page-item disabled">
                                    <!-- <a class="page-link" href="javascript:return">Next</a> -->
                                    <!-- classappend 추가해야함 -->
                                </li>
                            </th:block>

                        </ul>
                    </nav>
                </div>
            </div>




        </div>
    </div>

    <script>
        function bookinfo1(tags) {
            //console.log(`들어옴 ${tags}`)
            //console.log(tags.children[1])
            tags.children[1].style.display = 'block'

        }

        function bookinfo2(tags) {
            //console.log(`나감 ${tags}`)
            //console.log(tags.children[1])
            tags.children[1].style.display = 'none'
        }
        function bookDetail(bookCode) {
            // 책 하나 찾기
            console.log(bookCode)
            //모달 태그 찾기
            let book_modal = new bootstrap.Modal('#book-modal');

            // ------------------- 첫번째 방식 ---------------//
            fetch('/findBookDetailFetch', { //요청경로
                method: 'POST',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                },
                //컨트롤러로 전달할 데이터
                body: new URLSearchParams({
                    // 데이터명 : 데이터값
                    bookCode: bookCode
                })
            })
                .then((response) => {
                    if (!response.ok) {
                        alert('fetch error!\n컨트롤러로 통신중에 오류가 발생했습니다.');
                        return;
                    }

                    //return response.text(); //컨트롤러에서 return하는 데이터가 없거나 int, String 일 때 사용
                    return response.json(); //나머지 경우에 사용
                })
                //fetch 통신 후 실행 영역
                .then((data) => {//data -> controller에서 리턴되는 데이터!
                    console.log(data)
                    let modal_body_Tag = document.querySelector(".modal-body");

                    //안에내용 갈아엎기
                    modal_body_Tag.innerHTML = ''

                    let str = `
                             <div class="row">
                                <div class="col">
                                    <!-- 책 상세 정보들 넣어주기 -->
                                    <div class="row">
                                        <div class="col-6 text-center">
                                            <!-- 책 사진 들어가는곳  -->
                                            <img src="/upload/${data.bookInfoAttachedFileName}" width="261px" height="383px" alt="">
                                        </div>

                                        <div class="col-6 mt-5">
                                            <div class="row mt-5">
                                                <!-- 북 코드 -->
                                                <div class="col-2">코드 :</div>
                                                <div class="col" id="book-code">${data.bookCode}</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 제목 -->
                                                <div class="col-2">제목 :</div>
                                                <div class="col">${data.bookTitle}
                                                </div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 저자 -->
                                                <div class="col-2">저자 :</div>
                                                <div class="col">${data.bookWriter}</div>
                                            </div>

                                            <div class="row mt-2">
                                                <!-- 출판사 -->
                                                <div class="col-3">출판사 :</div>
                                                <div class="col">${data.bookPub}</div>
                                            </div>



                                            <div class="row mt-2">
                                                <!-- 현재 이 책을 빌릴 수 있는지 확인 -->
                                                <div class="col-4">대출 여부 :</div>
                                                <div class="col">${data.bookBorrowAvailable}</div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="row text-center mt-2">
                                        <!-- 카테고리 -->
                                        <div class="col-2">카테고리 </div>
                                        <div class="col-5">대분류 : ${data.bookCateName}/div>
                                        <div class="col-5">중분류 : ${data.bookMidCateName}</div>
                                    </div>

                                    <div class="row mt-2">
                                        <!-- 책 소개 -->
                                        <div class="col">
                                            <div class="row  text-center">
                                                <div class="col" style="border-bottom: solid 1px black;">
                                                    책소개
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col">
                                                    ${data.bookIntro}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                    `

                    modal_body_Tag.insertAdjacentHTML("afterbegin", str)
                    book_modal.show();


                })
                //fetch 통신 실패 시 실행 영역
                .catch(err => {
                    alert('fetch error!\nthen 구문에서 오류가 발생했습니다.\n콘솔창을 확인하세요!');
                    console.log(err);
                });
        }

        function cateChk(tag, cateList) {
            let cateName = tag.value
            let midCateTag = document.querySelector("#cate-tag");
            let str = '<option value="noMidCate" checked>중분류</option>';
            console.log(midCateTag)
            console.log(cateName)
            console.log(cateList)
            midCateTag.innerHTML = ''
            if (cateName != 'noCate') {
                for (let i of cateList) {
                    console.log(i)
                    if (i.bookCateName == cateName) {
                        for (let j of i.libraryBookMidCategoryVOList) {
                            str += `<option value=${j.bookMidCateName}>${j.bookMidCateName}</option>`
                        }
                    }
                }
            } else {
                midCateTag.innerHTML = ''
            }
            console.log(str)
            midCateTag.insertAdjacentHTML('afterbegin', str)
        }

        

    </script>
</th:block>

<th:block layout:fragment="content_js">
    <!-- html 파일이 열릴때 같이 실행되는 js -->
    <!-- <script src="/"></script> -->
</th:block>

</html>