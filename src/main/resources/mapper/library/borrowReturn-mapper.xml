<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 해당 파일에 모든 쿼리문을 작성 -->
<mapper namespace="bnrMapper">

    <resultMap id="bookBNR" type="com.green.Library.library.borrowReturn.vo.BookBNRVO">
        <id          column="BORROW_CODE"         property="borrowCode"/>
        <result      column="BORROW_DATE"         property="borrowDate"/>
        <result      column="RETURN_YN"           property="returnYN"/>
        <result      column="EX_RETURN_DATE"      property="exReturnDate"/>
        <result      column="RETURN_DATE"         property="returnDate"/>
        <result      column="USER_CODE"           property="userCode"/>
        <result      column="BOOK_CODE"           property="bookCode"/>
        <association property="libraryBookVO"     resultMap="libraryBookMapper.libraryBook"/>
    </resultMap>

    <resultMap id="bookReserve" type="com.green.Library.library.borrowReturn.vo.BookReservationVO">
        <id          column="RESERVE_CODE"        property="reserveCode"/>
        <result      column="USER_CODE"           property="userCode"/>
        <result      column="BOOK_CODE"           property="bookCode"/>
        <result      column="RESERVE_DATE"        property="reserveDate"/>
        <result      column="RESERVE_CANCEL"      property="reserveCancel"/>
        <result      column="RESERVE_STATUS"      property="reserveStatus"/>
        <result      column="RESERVE_CNT"         property="reserveCnt"/>
        <association property="libraryBookVO"     resultMap="libraryBookMapper.libraryBook"/>
    </resultMap>

<!-- ///////////// 이용자 정보 조회 및 수정 /////////////// -->

    <!-- 이용자의 대출, 반납, 예약 정보 조회-->
    <select id="selectBorrowInfo" resultMap="memberMapper.users">
        SELECT CARD_NUM
        , USER_INTRO
        , U.USER_CODE
        , USER_NAME
        , USER_TEL
        , POST_CODE
        , USER_ADDR
        , ADDR_DETAIL
        , BORROW_CODE
        , BORROW_DATE
        , RETURN_YN
        , EX_RETURN_DATE
        , RETURN_DATE
        , BBR.BOOK_CODE
        , BOOK_TITLE
        , BOOK_CATE_CODE
        , BOOK_MID_CATE_CODE
        , BOOK_INFO_ATTACHED_FILE_NAME
        , RESERVE_CODE
        , RESERVE_DATE
        , RESERVE_CANCEL
        FROM USERS U
        LEFT JOIN BOOK_BNR AS BBR
        ON U.USER_CODE = BBR.USER_CODE
        LEFT JOIN BOOK_RESERVATION AS BR
        ON U.USER_CODE = BR.USER_CODE
        LEFT JOIN BOOK AS B
        ON BBR.BOOK_CODE = B.BOOK_CODE
        LEFT JOIN BOOK_INFO AS BI
        ON BBR.BOOK_CODE = BI.BOOK_CODE
        WHERE U.CARD_NUM = #{cardNum}
        ORDER BY BORROW_DATE DESC
<!--        <if test="">-->
<!--          여기서부터 마이페이지에 쓸 대출반납 내역 조건 조회 쿼리 -->
<!--        </if>-->
    </select>

<!--    &lt;!&ndash; 대출반납 내역 전체 조회 &ndash;&gt; 첫번째 쿼리 재활용 예정-->
<!--    <select id="bNRSelect" resultMap="">-->
<!--        SELECT CARD_NUM-->
<!--            , USER_NAME-->
<!--            , USER_TEL-->
<!--            , BOOK_CODE-->
<!--            , BOOK_TITLE-->
<!--            , BOOK_CATE_CODE-->
<!--            , BOOK_MID_CATE_CODE-->
<!--            , BORROW_DATE-->
<!--            , EX_RETURN_ATE-->
<!--            , RETURN_DATE-->
<!--        FROM BOOK_BNR AS BBR-->
<!--        LEFT JOIN BOOK_-->
<!--        WHERE 1 = 1-->
<!--        <if test="">-->

<!--        </if>-->
<!--    </select>-->

<!-- ///////////////////// 대출 ///////////////////////// -->

    <!-- 데이터베이스에 존재하는 책인지 확인 -->
    <select id="isCorrectBookCode" resultType="String">
        SELECT
            BOOK_CODE
        FROM BOOK
        WHERE BOOK_CODE = #{bookCode}
    </select>

    <!-- 대출 진행 시 insert -->
    <insert id="insertBorrow">
        INSERT INTO BOOK_BNR (
            USER_CODE
            , BOOK_CODE
            , BORROW_DATE
            , EX_RETURN_DATE
        ) VALUES (
            #{userCode}
            , #{bookCode}
            , #{borrowDate}
            , DATE_ADD(#{borrowDate}, INTERVAL +14 DAY)
        )
    </insert>

    <!-- bookInfo update -->
    <update id="updateBookInfo">
        UPDATE BOOK_INFO
        SET
            BOOK_BORROW_AVAILABLE = 'N'
            , BOOK_BORROW_CNT = BOOK_BORROW_CNT + 1
        WHERE BOOK_CODE = #{bookCode}
    </update>

    <!-- 책 코드 찍기 전 유저 카드넘버 조회 -->
    <select id="selectUserCode" resultType="int">
        SELECT USER_CODE
        FROM USERS
        WHERE CARD_NUM = #{cardNum}
    </select>

<!-- ///////////////////////////////////////////////////////////   -->



<!-- //////////////////////// 반납 //////////////////////////// -->

    <!-- 책이 대출되어 있는 지 확인 이게 있어야 인풋 태그에 들어오는 책 코드가 대출인지 반납인지 알 수 있음 -->
    <select id="selectBookAvailable" resultType="String">
        SELECT BOOK_BORROW_AVAILABLE
        FROM BOOK_INFO
        WHERE BOOK_CODE = #{bookCode}
    </select>

    <!-- bookInfo update -->
    <update id="updateReturnBookInfo">
        UPDATE BOOK_INFO
        SET
            BOOK_BORROW_AVAILABLE = 'Y'
        WHERE BOOK_CODE = #{bookCode}
    </update>

    <!-- 반납 진행 시 update -->
    <update id="updateReturnInfo">
        UPDATE BOOK_BNR
        SET
            RETURN_YN = 'Y'
            , RETURN_DATE =
                CASE
                    WHEN #{returnDate} &lt; NOW() THEN #{returnDate}
                    ELSE NOW()
                END
        WHERE BOOK_CODE = #{bookCode}
    </update>

<!-- ////////////////////////////////////////////////////// -->



<!-- //////////////////////// 예약 //////////////////////////// -->

    <!-- 예약내역 확인 -->
    <select id="selectReservationList" resultMap="bookReserve">
        SELECT RESERVE_CODE
        , RESERVE_STATUS
        , CARD_NUM
        , BR.USER_CODE
        , BR.BOOK_CODE
        , USER_NAME
        , CARD_STATUS
        , USER_TEL
        , BOOK_TITLE
        , RESERVE_DATE
        , RESERVE_CANCEL
        FROM BOOK_RESERVATION AS BR
        LEFT JOIN USERS AS U
        ON BR.USER_CODE = U.USER_CODE
        LEFT JOIN BOOK AS B
        ON BR.BOOK_CODE = B.BOOK_CODE
        WHERE 1 = 1
        <if test='userName1 != null and !userName1.equals("")'>
            AND USER_NAME = #{userName1}
        </if>
        <if test='searchBookTitle != null and !searchBookTitle.equals("")'>
            AND BOOK_TITLE = #{searchBookTitle}
        </if>
        <if test='cardNum1 != null and !cardNum1.equals("")'>
            AND CARD_NUM = ${cardNum1}
        </if>
        <if test='bookCode1 != null and !bookCode1.equals("") and (bookCode2 == null or bookCode2.equals(""))'>
            AND BOOK_CODE BETWEEN #{bookCode1} AND (SELECT MAX(BOOK_CODE) FROM BOOK)
        </if>
        <if test='bookCode2 != null and !bookCode2.equals("") and (bookCode1 == null or bookCode1.equals(""))'>
            AND BOOK_CODE BETWEEN (SELECT MIN(BOOK_CODE) FROM BOOK) AND #{bookCode2}
        </if>
        <if test='bookCode1 != null and !bookCode1.equals("") and bookCode2 != null and !bookCode2.equals("")'>
            AND BOOK_CODE BETWEEN #{bookCode1} AND #{bookCode2}
        </if>
        <if test='reserveDate1 != null and !reserveDate1.equals("") and (reserveDate2 == null or reserveDate2.equals(""))'>
            AND RESERVE_DATE BETWEEN #{reserveDate1} AND NOW()
        </if>
        <if test='reserveDate2 != null and !reserveDate2.equals("") and (reserveDate1 == null or reserveDate1.equals(""))'>
            AND RESERVE_DATE BETWEEN CONCAT(YEAR(CURDATE()), '-01-01') AND #{reserveDate2}
        </if>
        <if test='reserveDate1 != null and !reserveDate1.equals("") and reserveDate2 != null and !reserveDate2.equals("")'>
            AND RESERVE_DATE BETWEEN #{reserveDate1} AND #{reserveDate2}
        </if>
        <if test='reserveCancel1 != null and !reserveCancel1.equals("") and (reserveCancel2 == null or reserveCancel2.equals(""))'>
            AND RESERVE_CANCEL BETWEEN #{cancelReserveDate1} AND NOW()
        </if>
        <if test='reserveCancel2 != null and !reserveCancel2.equals("") and (reserveCancel1 == null or reserveCancel1.equals(""))'>
            AND RESERVE_CANCEL BETWEEN CONCAT(YEAR(CURDATE()), '-01-01') AND #{cancelReserveDate2}
        </if>
        <if test='reserveCancel1 != null and !reserveCancel1.equals("") and reserveCancel2 != null and !reserveCancel2.equals("")'>
            AND RESERVE_CANCEL BETWEEN #{cancelReserveDate1} AND #{cancelReserveDate2}
        </if>
    </select>

    <!-- 반납 된 후 해당 책이 예약이 있는지 확인 -->
    <select id="selectChkReservation" resultMap="bookReserve">
        SELECT RESERVE_CODE
            , USER_CODE
        FROM BOOK_RESERVATION
        WHERE BOOK_CODE = #{bookCode}
        AND RESERVE_STATUS = '대기중'
    </select>

    <!-- 반납 후 해당 책이 예약 내역이 있을 경우 예약 진행 -->
    <update id="updateHasReservation">
        UPDATE BOOK_RESERVATION
            SET
                RESERVE_CANCEL = DATE_ADD(NOW(), INTERVAL +3 DAY)
        WHERE BOOK_CODE = #{bookCode}
    </update>

    <!-- 이용자가 예약 한 책을 기한 내에 대출 하러 왔을 경우(해당 이용자가 예약 한 게 맞는지 확인) -->
    <select id="selectGetReservation" resultMap="bookReserve">
        SELECT RESERVE_CODE
        FROM BOOK_RESERVATION
        WHERE BOOK_CODE = #{bookCode}
        AND USER_CODE = #{userCode}
    </select>

    <!-- 이용자가 예약 한 책을 기한 내에 대출 하러 왔을 경우(예약 내역에 보여줄 상태 변경) -->
    <update id="updateGetBorrow">
        UPDATE BOOK_RESERVATION
            SET
                RESERVE_STATUS = '대출완료'
        WHERE USER_CODE = #{userCode}
        AND BOOK_CODE = #{bookCode}
    </update>

<!-- ////////////////////////////////////////////////////// -->

</mapper>
